#!/usr/bin/env node

var fs = require("fs")
var path = require("path")
var program = require("commander")
var marked = require("marked")
var title = require("to-title-case")
var chalk = require("chalk")
var git = require("../lib/git")
var App = require("..")

function green(msg) {
  console.log(chalk.green(msg))
}

function red(msg) {
  console.error(chalk.red(msg))
}

program
  .command("init")
  .description("Create an app.json for the current directory's app")
  .option("-a, --app <heroku-app-name>", "Specify a Heroku app from which to derive addons and env")
  .action(function(program){

    if (fs.existsSync(process.cwd() + "/app.json")) {
      return console.log("This directory already contains an app.json. Run `app.json validate` to verify it.")
    }

    var app = App.new()
    app.name = title(path.basename(process.cwd()))
    app.description = "TODO: Add a short description about " + app.name
    app.keywords = ["small", "sharp", "tool"]
    app.website = "TODO: Add website URL"
    app.repository = "TODO: Add repository URL"
    app.logo = "TODO: Add logo URL"
    app.addons = []
    app.env = {}

    var done = function() {
      fs.writeFile(process.cwd() + "/app.json", app.toJSON, function(err) {
        if (err) console.error(err)
        green("Created app.json\n")
        console.log(app.toJSON)
      })
    }

    if (program.app) {
      app.deriveAddonsAndEnvFromHerokuApp(program.app, function(err) {
        if (err) return console.error(err)
        return done()
      })
    } else {
      git.parseHerokuAppNames(function(err, names) {
        if (err) return console.error(err)

        if (!names.length) return done()

        if (names.length > 1) {
          console.log("Multiple Heroku git remotes found. Try one of these commands:\n")
          names.forEach(function(name) {
            console.log("app.json init --app " + name)
          })
          return
        }

        app.deriveAddonsAndEnvFromHerokuApp(names[0], function(err) {
          if (err) return console.error(err)
          return done()
        })

      })
    }

  })

program
  .command("validate")
  .description("Validate the app.json file in the current directory")
  .action(function(program){

    var manifest = process.cwd() + "/app.json"
    if (fs.existsSync(manifest)) {

      try {
        JSON.parse(fs.readFileSync(manifest).toString())
      } catch(err) {
        return red("Found an app.json file, but it's invalid JSON.")
      }

      var app = App.new(manifest)

      if (app.valid) {
        green("\nYour app.json file is valid!\n")
        console.log(app.toJSON)
      } else {
        red("Found an app.json file, but it's got some issues:\n")
        console.error(app.errorString)
      }
    } else {
      red("No app.json found. Use `app.json init` to create one.")
    }
  })

program
  .command("schema")
  .option('--markdown', 'Write the schema in markdown format')
  .option('--html', 'Write the schema in HTML format')
  .description("Write the app.json schema to STDOUT")
  .action(function(program){
    if (program.markdown) {
      process.stdout.write(App.templates.schema.render(App.schema))
    } else if (program.html) {
      process.stdout.write(marked(App.templates.schema.render(App.schema)))
    } else {
      process.stdout.write(JSON.stringify(App.schema.properties, null, 2))
    }
  })

program
  .command("deploy <repo>")
  .description("Deploy an app.json-enabled app from GitHub using its shorthand URL.")
  .action(function(repo){
    var bin = path.resolve(__dirname, '../bin/deploy')
    var ps = require('child_process').spawn(bin, [repo])

    ps.stdout.on('data', function (data) {
      process.stdout.write(data.toString())
    })

    ps.stderr.on('data', function (data) {
      console.log(data.toString())
    })

    ps.on('exit', function (code) {
    })

  })

// Print this after the generated help text
program.on("--help", function(){
  console.log("  Use 'app <command> --help' to get more information about a specific command.")
  console.log('')
})

program.parse(process.argv)

if(program.args.length < 1){
  program.help()
}
